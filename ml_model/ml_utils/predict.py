import pandas as pd
import numpy as np
import os
import joblib

#  设定类别顺序（与训练时一致）
CATEGORIES = ["Coffee & Tea Shops", "Afghan", " Takeaway & Fast Food", "Persian/Iranian", " Afghan", " Seafood", " Middle Eastern", "Middle Eastern", " Armenian", "Indian", "Asian Fusion", " Burgers", " Chicken Shop", " Pizza", "African", " Cafes", "Ethiopian", " Halal", " African", "Caribbean", " British", " Cocktail Bars", " Modern European", " Bars", "Portuguese", " French", "Pubs", " Portuguese", " Food Delivery", "Airport Lounges", "Airport Terminals", "Airports", "Lounges", " Champagne Bars", " Mediterranean", "Shisha Bars", "Mediterranean", "Lebanese", "Moroccan", "Falafel", "Arabic", "Argentine", "Peruvian", " Latin American", " Argentine", "Brazilian", " Steakhouses", "Steakhouses", "Greek", "Armenian", "Thai", " Indian", "Japanese", " Asian Fusion", " Thai", "Chinese", " Vietnamese", " Japanese", " Sushi", " Imported Food", "Takeaway & Fast Food", " Chinese", "Szechuan", " Pakistani", "Pan Asian", "British", "Food Courts", "Bars", "Hawaiian", "Buffet", " Korean", " New American", "Australian", "Cafes", " Breakfast & Brunch", " Australian", " Sports Bars", "Food Trucks", " Bagels", "Bakeries", " Delis", "Bagels", " Bakeries", "Delis", " Coffee & Tea Shops", " Street Food", " Local Flavour", "American", "Supermarkets", " Sandwiches", " Juice Bar & Smoothies", " Desserts", "Desserts", " Tea Rooms", " Delicatessen", " Cheese Shops", "Tea Rooms", "Breakfast & Brunch", " Wine Bars", " Soul Food", " Music Venues", "New American", " Diners", " Breweries", "Burgers", " Chocolate & Chocolatiers", " Cake Shop & Patisserie Shops", "Cake Shop & Patisserie Shops", " Lebanese", "Cupcakes", " Flowers & Gifts", " Greengrocers", " Health Food", " Caterers", "Vegetarian", "Wholesale", " Specialty Food", " Corner Shops", " Internet Cafes", "Off Licence", " Supermarkets", "Meat Shops", " Butchers", "Caterers", " Buffet", "Custom Cakes", " Cupcakes", " Donuts", "Sweet Shops", "Donuts", "Chocolate & Chocolatiers", " Bangladeshi", " Himalayan/Nepalese", "Bangladeshi", "Barbers", "Spanish", "Basque", " Spanish", " Basque", " Tapas & Small Plates", "Tapas & Small Plates", "Wine Bars", "BBQ & Barbecue", " Smokehouse", " American", " BBQ & Barbecue", "Turkish", " Vegetarian", " Personal Chefs", " Pubs", "Corner Shops", " Off Licence", "Cheese Shops", " Newsagents", " Tobacconists", " Printing & Photocopying ", "Nan", "Tobacconists", " Carpet Fitters", " German", " Czech", " Clubs", " Dive Bars", "Beer Bars", " Irish Pubs", " Venues & Event Spaces", "Music Venues", " Lounges", " Gay Bars", " Pool & Snooker Hall", "Pizza", " Mexican", " Gastro Pubs", "Karaoke", "Gastro Pubs", "Breweries", " Beer Bars", "Sports Bars", " Art Galleries", "Comedy Clubs", "Hotels", " Jazz & Blues", " Food", " Wine Tasting Classes", "Clubs", "Cocktail Bars", "Dive Bars", " B&Bs", " Tapas Bars", "Golf", " Italian", "Street Food", " Scandinavian", " Cultural Centres", " Theatres", " Ramen", " Tours", "Whiskey Bars", " Operas", " Hotels", " Cinemas", " Moroccan", "Modern European", "French", "Bistros", " Bistros", "Property Services", "Jazz & Blues", "Brasserie", " Brasserie", "Italian", "Cinemas", " Shopping Centers", "Latin American", "Farms", " Meat Shops", "Juice Bar & Smoothies", " Salad", "Cuban", "Brewpubs", " Festivals", "Distilleries", " Event Planning & Event Services", "Gay Bars", " Vegan", "Fish & Chips", " Gluten Free", "Casinos", " Karaoke", "Community Service & Non Profit", "Bubble Tea", "Ice Cream & Frozen Yoghurt", " Waffles", " Crepes", "Vietnamese", "Halal", " Brazilian", "Organic Shops", "Pakistani", "Restaurants", "Sushi", " Noodles", " Cafeterias", " Restaurants", " Wine Tasting Room", "Dim Sum", "Polish", " Chicken Wings", " Kebab", "Chicken Wings", " Milkshake Bars", "Mexican", " Hot Dogs", " Tex-Mex", "Hot Dogs", "Bowling", " Fish & Chips", "Chicken Shop", "Kebab", "Markets", "Smokehouse", "Health Food", "Food Delivery", "Vegan", " Ice Cream & Frozen Yoghurt", "Milkshake Bars", "Butchers", " Farms", "Seafood Markets", " Seafood Markets", " Flea Markets & Car Boot Sales", " Vintage & Second Hand", "Herbs & Spices", " International Grocery", "Gardening Centres", " Shopping", "Greengrocers", " Wholesale", "Market Stalls", " Markets", "Social Clubs", " Bookshops", "Sandwiches", "Irish", " Bikes", " Bike Repair & Maintenance", " Soup", "Venues & Event Spaces", " Community Service & Non Profit", "Cafeterias", " University & Colleges", "Cajun/Creole", " Cajun/Creole", "Imported Food", "Florists", " Sweet Shops", "Arts & Crafts", " Toy Shops", " Pound Shops", " Cards & Stationery", " Gift Shops", "Specialty Food", "Gift Shops", " Kitchen Supplies", "Shopping Centers", "Camera Shops", "Toy Shops", "Korean", "Newsagents", " Print Media & Publications", "Art Supplies", " Fabric & Haberdashery", " Florists", "Bookshops", " Comics", "Local Flavour", " Antiques", "Vintage & Second Hand", " Jewellery", " Accessories", "Packing Supplies", " Wholesalers", "Pound Shops", " Women's Clothing", "Musical Instruments & Teachers", "Food Stands", "Fashion", " Children's Clothing", "Department Stores", "Hobby Shops", "Swimming Pools", " Recreation Centres", "Flowers & Gifts", "Eyewear & Opticians", "Party Supplies", " Balloon Services", " Polish", "Cards & Stationery", "Shoe Shops", "Home & Garden", "Delicatessen", " Personal Shopper", "Shopping", "Beauty & Makeup", "Charity Shops", "Furniture Shops", " Office Equipment", " Home Decor", "Home Decor", " Men's Clothing", " Leather Shops", "Accessories", "IT Services & Computer & Laptop Repair", " Computers", " Mobile Phones", "Women's Clothing", " Caribbean", "Champagne Bars", " Cuban", "Cambodian", " Food Courts", "Tapas Bars", " Greek", " Flats", "Office Equipment", " Cantonese", " Dim Sum", "Cantonese", " Mongolian", "Tiki Bars", "Crazy Golf", "Wine Tours", "Theatres", " Shisha Bars", " Coffee & Tea Supplies", "Coffee Roasteries", "Coffee & Tea Supplies", "Sporting Goods", "Fabric & Haberdashery", "Lingerie", " Hobby Shops", " Organic Shops", "Music & DVD", " Vinyl Records", "Museums", "Art Galleries", " Guitar Stores", " Piano Stores", "Bikes", " Arts & Crafts", "Pet Shops", " Shoe Shops", " Candle Stores", "Baby Accessories & Furniture ", "Crepes", "Waffles", " Event & Party Planning", "Diners", " Custom Cakes", " Cooking Classes", "Event & Party Planning", "Pasta Shops", "Food", " Pharmacies", "Frozen Food", " Beer Gardens", "Arena & Stadiums", " Arcades", "Kitchen & Bath", " Home & Garden", "Hardware Stores", " Kitchen & Bath", "Himalayan/Nepalese", " Pop-Up Restaurants", " Ethiopian", "Christmas Markets", " Food Stands", "Pharmacies", "Flea Markets & Car Boot Sales", "Aquariums", " Market Stalls", " Malaysian", "Pop Up Shops", "Festivals", "Filipino", "International Grocery", "Ramen", "Ukranian", "Gluten Free", " Pet Shops", "Personal Chefs", " Unofficial Yelp Events", " Sports & Leisure", " Government & Public Services", " Swimming Pools", " Crazy Golf", " Park & Forests", " Food Trucks", "German", "Salad", " Turkish", " Beauty & Makeup", " Baby Accessories & Furniture ", " Hawaiian", "Weight Loss Centres", " Personal Trainers", " Nutritionists", "Nutritionists", " Herbs & Spices", "Indonesian", "Sri Lankan", "University Accommodation", "International", "Internet Cafes", "Libraries", "Estate Agents", " DIY Food", "Irish Pubs", " Comedy Clubs", " Falafel", "Sports Clubs", "Strip Clubs", "University & Colleges", "Macarons", " Macarons", "Malaysian", " Wineries", "Tex-Mex", "Russian", " Persian/Iranian", "Train Stations", "Metro Stations", " Bus Stations", "Pool & Snooker Hall", " Sports Clubs", " Arena & Stadiums", "Landmarks & Historic Buildings", "Airlines", "Travel Agents", "Football", " Professional Sports Teams", " Health & Medical", "Professional Services", " Pharmacy & Chemists", " Perfume", "Shared Office Spaces", "Pharmacy & Chemists", "Pancakes", "Pop-Up Restaurants", "Scandinavian", " Furniture Shops", "Antiques", " Interior Design", "Scottish", "Seafood", " Singaporean", " Wedding Planners", "Soup", " Speakeasies", "Arts & Entertainment", " Music & DVD", " Social Clubs", "Syrian", "Taiwanese", "Sports Wear", "Playgrounds", "Mass Media", "Burmese", "Climbing", " Yoga", "Wineries", " Arabic", " Syrian", " Bubble Tea", "Cookery Schools", " Pop Up Shops", "Jobcentres", "Post Offices", "Financial Services", " Irish", " Choirs", "Austrian", " Belgian", "Brewing Supplies", " Brewpubs", "Tours", "Park & Forests", " Sri Lankan", " Building Supplies", "Used Bookstores", "Botanical Gardens", " Museums", " Party Supplies", "Mobile Phones", " Stables & Horse Riding ", " Piercing", "Fireworks", " Rugs", " Department Stores", " Concept Stores", "Jewellery", " Watches", " Payday Loans & Cheque Cashing", " Gardening Centres", "Men's Clothing", " Whiskey Bars", "Singaporean", "Noodles", " Cideries", "Cideries", "Body Shops", "Vinyl Records", "E Cigarette", "Watches", " Watch Repair", "Spiritual Shops", "Mobile Phone Repair", " Mobile Phone Accessories", "Children's Clothing", " Bed Shops", "Bridal", "Fancy Dress", "Computers", " Charity Shops", "Concept Stores", " Fashion", " Hair Extensions", "Hairdressers", " Spa", "Electronics", " Fishing", "Funeral Services & Cemeteries", "Parking", "Outdoor Gear", " Outdoor Furniture Stores", " Outdoor Gear", " Packing Supplies", "Wedding Planners", "Arcades", "DIY Food", " Frozen Food", " Kids Activities", " Hardware Stores", "Gas Stations", "Outlet Stores", " Public Markets", " Pet Services", "Advertising", " Holistic & Naturopathic", "Local Fish Stores", " Aquariums", " Cabarets", " Vitamins & Supplements", " Ethical Grocery", " Weight Loss Centres", " Fertility Clinic & Treatment", " Allergists", "Hungarian", "Kosher", " E Cigarette", "Nightlife", "Hotel & Travel", "Public Transport", "Cultural Centres", "Print Media & Publications", " Cookery Schools", " Southern", "Speakeasies", "MOT Test Centres", "Yelp Events", "Recording & Rehearsal Studios", "Guest Houses", " Landmarks & Historic Buildings", "B&Bs", " Religious Organisations", "Accountants", " Arts & Entertainment", " Adult Education", " Hair Stylists", " Russian", " Peruvian", " Filipino", " Austrian", "Music", " Video", " Books & Magazines", " Coffee Roasteries", "Belgian", "Dentists", "Taxi & Minicabs", "Beer Gardens", " Bowling", " Hostels", "Fondue", " Piano Bars", " Hairdressers", " International", " Churches", " Taiwanese", " Burmese", "Pet Sitting", " Pet Groomers", " Live & Raw Food", " Indonesian", "Bulgarian", " Bulgarian", " Nightlife", "Marketing", " Themed Cafes", " Used Bookstores", "Acai Bowls", " Rest Stops", " Scottish", "Public Markets", " Pasta Shops", " Cheesesteaks", "Mongolian", " Pan Asian", " Cambodian", "Walking Tours", " Food Tours", " Distilleries", " DJs", "Art Schools", " Recording & Rehearsal Studios", " Luggage", "Leather Shops", " Bike Hire", " Supernatural Readings", "Comics", "Framing", " Camping & Campsites", " Knitting Shops", " Art Classes", " Camera Shops", " Bridal", " Spiritual Shops", " Poke", " Kosher", " Tabletop Games", "Art Museums", "Event Planning & Event Services", " Pool & Billiards", " Hotel & Travel", " Flooring & Tiling", " Dumplings", " Georgian", "Czech", " Fondue", "Local Services", "Community Centres", "Mauritius", "Georgian", " Guest Houses", "Hostels", " Gas Stations", "Poke", " Skin Care", "Live & Raw Food", " Dietitians", "Herbal Shops", "Gyms", "Personal Trainers", " Gyms", " Sports Wear", " Fitness & Exercise Equipment", " Hungarian", " Traditional Chinese Medicine", " Herbal Shops", " Couriers & Delivery Services", " Couriers", " IT Services & Computer & Laptop Repair", "Videos & Video Game Rentals", "Internet Service Providers", "Themed Cafes", " Shared Office Spaces", " Dinner Theater", "Keys & Locksmiths", "Laotian", "Southern", "Zoos", "Skin Care", "Perfume", "Massage", " Acupuncture", " Pancakes", "Soul Food", " Party Equipment Hire", "Game Meat", " Szechuan", "Wine Tasting Room", "Historical Tours", " Bus Tours", "Bus Tours", " Historical Tours", " Tasting Classes", "Cabarets", " Tennis"]

#  模型加载（缓存机制避免重复加载）
_model = None
def load_model():
    global _model
    if _model is None:
        model_path = os.path.join('ml_model\predict_models', 'rf_regressor_UK.pkl')
        _model = joblib.load(model_path)
    return _model

#  One-hot 编码辅助函数
def one_hot_encode_categories(category_str):
    one_hot = np.zeros(len(CATEGORIES))
    category_list = [cat.strip() for cat in str(category_str).split(',')]
    for i, cat in enumerate(CATEGORIES):
        if cat in category_list:
            one_hot[i] = 1
    return one_hot

#  主预测函数：接受 Property 实例列表，返回预测后的 DataFrame
def predict_success_for_properties(properties):
    model = load_model()
    data = []

    for prop in properties:
        base = {
            "id": prop.id,
            "address": prop.address,
            "price": prop.price,
            "space": prop.space,
            "availability": prop.availability,
            "market": prop.market,
            "submarket": prop.submarket,
            "access_link": prop.access_link,
            "image": prop.image,
            'categories': prop.categories,  # 保留原始字符串以供参考
            'RestaurantsPriceRange': prop.RestaurantsPriceRange,
            'Adjusted_Price': prop.Adjusted_Price,
            'competitor_density': prop.competitor_density,
            'transport_density': prop.transport_density,
            'shopping_density': prop.shopping_density,
            'education_density': prop.education_density,
            'healthcare_density': prop.healthcare_density,
        }

        one_hot = one_hot_encode_categories(prop.categories)
        one_hot_dict = dict(zip(CATEGORIES, one_hot))
        data.append({**base, **one_hot_dict})

    df = pd.DataFrame(data)
    # 明确分离模型需要的输入特征（去掉非模型字段）
    feature_cols = [col for col in df.columns if col not in ['id', 'address', 'price', 'space','availability','market',
                                                             'submarket','access_link','image','categories']]
    
    print("Start predicting......")

    df['success_index'] = model.predict(df[feature_cols].values)

    return df
